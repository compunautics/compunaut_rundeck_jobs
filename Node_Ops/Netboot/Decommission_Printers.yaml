- defaultTab: monitor
  description: Use this job to decommission printers from saltstack, consul, and influxdb.
  executionEnabled: true
  group: Netboot
  loglevel: INFO
  name: Decommission Printers
  nodeFilterEditable: false
  nodefilters:
    dispatch:
      excludePrecedence: true
      keepgoing: false
      rankOrder: ascending
      successOnEmptyNodeFilter: false
      threadcount: '1'
    filter: 'name: .*salt.*'
  nodesSelectedByDefault: true
  options:
  - description: Specify the name of the printer that you would like to decommission.
    name: node_to_decommission
    regex: .*-prtr.*
    required: true
    value: .*-prtr.domain.name
  scheduleEnabled: true
  sequence:
    commands:
    - description: Delete node key
      jobref:
        args: -key_to_delete ${option.node_to_decommission}
        group: Saltstack
        name: Delete Keys
        nodeStep: 'true'
    - description: Delete node from Consul
      jobref:
        args: -node_to_remove ${option.node_to_decommission}
        group: Linux
        name: Decommission node from Consul
        nodeStep: 'true'
    - description: Delete node from Influxdb
      jobref:
        args: -node_to_remove ${option.node_to_decommission}
        group: Linux
        name: Decommission node from Influxdb
        nodeStep: 'true'
    - description: Update Data
      jobref:
        args: -salt_target "*vpn* or *proxy*"
        group: Saltstack
        name: Update Data
        nodeStep: 'true'
    - description: Apply compunaut_haproxy on proxy servers
      exec: sudo salt "*proxy*" state.apply compunaut_haproxy --state_output=mixed
    - description: Apply compunaut_dnsmasq and openvpn.config on vpn servers
      exec: sudo salt "*vpn*" state.apply compunaut_dnsmasq,openvpn.config --state_output=mixed
    keepgoing: false
    strategy: node-first
  timeout: '300'

